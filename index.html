<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Naufal Finance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--grad:linear-gradient(135deg,#6a11cb,#000)}
*{box-sizing:border-box;font-family:Inter,Segoe UI,Arial}
body{margin:0;background:#0d0d0d;color:#fff}
header{background:var(--grad);padding:16px 24px;position:sticky;top:0;z-index:1000}
main{padding:24px;max-width:1200px;margin:auto}
.card{background:#161616;border-radius:14px;padding:20px;margin-bottom:20px}
form{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
input,select,button{padding:10px;border-radius:8px;border:none}
input,select{background:#222;color:#fff}
button{background:var(--grad);color:#fff;font-weight:600;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #333}
.in{color:#4ade80}
.out{color:#f87171}
</style>
</head>

<body>
<header><h1>Naufal Finance</h1></header>
<main>

<div class="card">
<h2>Input Keuangan</h2>
<form id="financeForm">
<input type="date" id="tanggal" required>
<input type="number" id="nominal" placeholder="Nominal" required>
<select id="kategori">
<option>Cash In</option>
<option>Cash Out</option>
<option>Gopay In</option>
<option>Gopay Out</option>
<option>Gopay Transport In</option>
<option>Gopay Transport Out</option>
</select>
<input type="text" id="deskripsi" placeholder="Deskripsi">
<button>Simpan</button>
</form>
</div>

<div class="card">
<h2>Ringkasan</h2>
<p>Total In: <b class="in" id="totalIn">Rp0</b></p>
<p>Total Out: <b class="out" id="totalOut">Rp0</b></p>
<p>Saldo: <b id="saldoTotal">Rp0</b></p>
</div>

<div class="card">
<h2>Grafik Pengeluaran</h2>
<canvas id="chart"></canvas>
</div>

<div class="card">
<h2>History</h2>
<select id="bulanSelect"></select>
<table>
<thead>
<tr>
<th>Tanggal</th>
<th>Nominal</th>
<th>Kategori</th>
<th>Deskripsi</th>
<th>Aksi</th>
</tr>
</thead>
<tbody id="history"></tbody>
</table>
</div>

</main>

<script>
const API = "https://script.google.com/macros/s/AKfycbxfBh2z29bUTda8sZtoxho6qrs_me0W0T3pVciHz9FoG7pFhr2akt84VV-s4w15eYPS/exec";

let allData = {};
let chart;

function getMonth(){
  const d=new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
}

let currentMonth = getMonth();
const bulanSelect = document.getElementById("bulanSelect");

/* ================= LOAD DATA ================= */
function loadDataFromAPI(){
  fetch(API)
    .then(res=>res.json())
    .then(data=>{
      allData = {};
      data.forEach(d=>{
        if(!allData[d.bulan]) allData[d.bulan]=[];
        allData[d.bulan].push(d);
      });
      loadMonths();
      render();
    });
}

function loadMonths(){
  bulanSelect.innerHTML="";
  Object.keys(allData).sort().forEach(b=>{
    const o=document.createElement("option");
    o.value=b;o.textContent=b;
    bulanSelect.appendChild(o);
  });
  if(!allData[currentMonth]){
    currentMonth = Object.keys(allData)[0];
  }
  bulanSelect.value=currentMonth;
}

/* ================= RENDER ================= */
function render(){
  const tbody=document.getElementById("history");
  tbody.innerHTML="";

  let totalIn=0,totalOut=0;
  let kategoriOut={};

  (allData[currentMonth]||[]).forEach((d,i)=>{
    tbody.innerHTML+=`
      <tr>
        <td>${d.tanggal}</td>
        <td>Rp${d.nominal}</td>
        <td>${d.kategori}</td>
        <td>${d.deskripsi}</td>
        <td><button onclick="hapusItem(${i})">‚ùå</button></td>
      </tr>`;

    if(d.kategori.includes("Out")){
      totalOut+=d.nominal;
      kategoriOut[d.kategori]=(kategoriOut[d.kategori]||0)+d.nominal;
    } else {
      totalIn+=d.nominal;
    }
  });

  totalInEl.innerText="Rp"+totalIn;
  totalOutEl.innerText="Rp"+totalOut;
  saldoTotal.innerText="Rp"+(totalIn-totalOut);

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"pie",
    data:{
      labels:Object.keys(kategoriOut),
      datasets:[{data:Object.values(kategoriOut)}]
    }
  });
}

/* ================= SUBMIT ================= */
financeForm.addEventListener("submit",e=>{
  e.preventDefault();
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      tanggal:tanggal.value,
      nominal:Number(nominal.value),
      kategori:kategori.value,
      deskripsi:deskripsi.value,
      bulan:currentMonth
    })
  }).then(()=>{
    financeForm.reset();
    loadDataFromAPI();
  });
});

/* ================= DELETE ================= */
function hapusItem(index){
  if(!confirm("Hapus data ini?")) return;
  const row = allData[currentMonth][index].row;
  fetch(`${API}?row=${row}`,{method:"DELETE"})
    .then(loadDataFromAPI);
}

/* ================= INIT ================= */
bulanSelect.addEventListener("change",()=>{
  currentMonth=bulanSelect.value;
  render();
});

const totalInEl=document.getElementById("totalIn");
const totalOutEl=document.getElementById("totalOut");
const saldoTotal=document.getElementById("saldoTotal");

loadDataFromAPI();
</script>
</body>
</html>
